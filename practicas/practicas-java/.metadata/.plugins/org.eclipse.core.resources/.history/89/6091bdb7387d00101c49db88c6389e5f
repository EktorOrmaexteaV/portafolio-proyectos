package com.cajero.gui;

import java.awt.*;
import javax.swing.*;
import java.util.*;
import javax.swing.table.*;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;

import com.cajero.Cajero;

public class Reporte {
	private JFrame frmReporte;
	private JTable tblDatos;
	
	private final String cuenta;
	private String usuario;
	private String saldo;
	
	private DefaultTableModel tableModel;
	
	Cajero cajero = new Cajero();
	
	public Reporte(String cuenta) {
		this.cuenta = cuenta;
		
		if(!cajero.confirmarCuenta(cuenta)) {
			JOptionPane.showMessageDialog(
					frmReporte,
					"<html>" +
					"Cuenta no encontrada.<br>" +
					"Por favor, verifique el número de cuenta ingresado." +
					"</html>",
					"Error",
					JOptionPane.ERROR_MESSAGE);
			frmReporte.dispose();
			new Main();
		}
		
		usuario = cajero.getUsuarioSesion();
		saldo = String.valueOf(cajero.getSaldoSesion());
		iniciar();
		frmReporte.setLocationRelativeTo(null);
        inicializarTabla();
	}
	
	private void iniciar() {
		frmReporte = new JFrame();
		frmReporte.getContentPane().setBackground(new Color(60, 63, 65));
		frmReporte.getContentPane().setLayout(null);
		
		JPanel panel = new JPanel(new BorderLayout());
		panel.setBounds(50, 100, 500, 400);
		frmReporte.getContentPane().add(panel);
		
		// Cambiar a BoxLayout para panelDatos y establecer tamaño preferido
		JPanel panelDatos = new JPanel();
		panelDatos.setBackground(new Color(60, 63, 65));
		panelDatos.setLayout(new BoxLayout(panelDatos, BoxLayout.Y_AXIS));
		panelDatos.setPreferredSize(new Dimension(500, 80)); // altura suficiente para los labels
		panel.add(panelDatos, BorderLayout.NORTH);
		
		// Crear panel para los labels con alineación a la izquierda
		JPanel labelsPanel = new JPanel();
		labelsPanel.setBackground(new Color(60, 63, 65));
		labelsPanel.setLayout(new GridLayout(3, 2, 5, 5));
		labelsPanel.setMaximumSize(new Dimension(500, 60));

		JLabel lblNewLabel = new JLabel("Nombre:");
		lblNewLabel.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblNewLabel);
		JLabel lblUsuario = new JLabel(usuario);
		lblUsuario.setFont(new Font("Courier 10 Pitch", Font.BOLD, 12));
		lblUsuario.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblUsuario);

		JLabel lblcuenta = new JLabel("Cuenta:");
		lblcuenta.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblcuenta);
		JLabel lblCuenta = new JLabel(cuenta);
		lblCuenta.setFont(new Font("Courier 10 Pitch", Font.BOLD, 12));
		lblCuenta.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblCuenta);

		JLabel lblSaldoActual = new JLabel("Saldo actual:");
		lblSaldoActual.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblSaldoActual);
		JLabel lblSaldo = new JLabel(saldo);
		lblSaldo.setFont(new Font("Courier 10 Pitch", Font.BOLD, 12));
		lblSaldo.setForeground(new Color(204, 204, 204));
		labelsPanel.add(lblSaldo);

		panelDatos.add(labelsPanel);
		
		tblDatos = new JTable();
		JScrollPane scrollPane = new JScrollPane(tblDatos);
		panel.add(scrollPane, BorderLayout.CENTER);

		
		JButton btnSalir = new JButton("Salir");
		btnSalir.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				confirmarSalida();
			}
		});
		btnSalir.setForeground(Color.LIGHT_GRAY);
		btnSalir.setBackground(new Color(60, 63, 65));
		btnSalir.setBounds(573, 463, 100, 27);
		frmReporte.getContentPane().add(btnSalir);
		
		JButton btnImprimir = new JButton("<html>\n  <div style='text-align: center;'>\n    Imprimir<br>reporte\n  </div>\n</html>\n");
		btnImprimir.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				cajero.generarReporte(cuenta);
				JOptionPane.showMessageDialog(
						frmReporte, 
						"Reporte generado exitosamente.", 
						"Éxito", 
						JOptionPane.INFORMATION_MESSAGE);
				//frmReporte.dispose();
			}
		});
		btnImprimir.setBounds(573, 386, 100, 50);
		frmReporte.getContentPane().add(btnImprimir);
		frmReporte.setBounds(100, 100, 700, 600);
		frmReporte.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frmReporte.setTitle("Reporte de Cuenta");
		frmReporte.setResizable(false);
		frmReporte.setVisible(true);
		
		frmReporte.addWindowListener(new java.awt.event.WindowAdapter() {
			@Override
			public void windowClosing(java.awt.event.WindowEvent windowEvent) {
				confirmarSalida();
			}
		});
	}
	
	private void confirmarSalida() {
		JOptionPane.showMessageDialog(
				frmReporte,
				"Saliendo de reporte de cuenta.",
				"Información",
				JOptionPane.INFORMATION_MESSAGE);
		frmReporte.dispose();
	}
	
	private void cargarDatos(String cuenta) {
		String query = "SELECT " +
                "    t.fecha, " +
                "    t.monto AS monto_transaccion, " +
                "    t.descripcion " +
                "FROM " +
                "    cuenta c " +
                "JOIN " +
                "    usuario u ON c.ID_Usuario = u.ID " +
                "JOIN " +
                "    transaccion t ON t.ID_Cuenta = c.ID " +
                "WHERE " +
                "    c.ID = '" + cuenta + "' " +
                "    AND t.tipo_evento IN ('INGRESO', 'RETIRO', 'CONSULTA') " +
                "ORDER BY " +
                "    t.fecha;";
		
		java.util.List<Map<String, String>> resultados = cajero.ejecutarConsultaSQL(query);		
		tableModel.setRowCount(0);
		
		for (Map<String, String> row : resultados) {
			String fecha = row.get("fecha");
            String monto = row.get("monto_transaccion");
            String descripcion = row.get("descripcion");
            tableModel.addRow(new Object[]{fecha, monto, descripcion});
		}
		
	}
	
	private void inicializarTabla() {
		tableModel = new DefaultTableModel(new Object[]{"Fecha", "Monto", "Descripción"}, 0 );
		tblDatos.setModel(tableModel);
		cargarDatos(cuenta);
	}
	
	public static void main(String[] args) {
		EventQueue.invokeLater(() -> {
			try {
				new Cuenta("11111111111111111111"); // Aquí se debe pasar el número de cuenta real
			} catch (Exception e) {
				e.printStackTrace();
			}
		});
	}
}
