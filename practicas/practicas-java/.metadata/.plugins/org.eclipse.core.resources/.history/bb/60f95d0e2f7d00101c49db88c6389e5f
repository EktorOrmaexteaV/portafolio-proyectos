package com.cajero;

import com.managment.utils.InputUtils;
import com.managment.utils.SystemUtils;
import static com.managment.utils.SystemUtils.*;

/**
 * Proyecto		: Cajero
 * Archivo		: main.java
 * Descripción	: Simula un sistema de cajero automático básico que permite		
 * 	              iniciar sesión, consultar saldo, depositar y retirar dinero 
 *                y crear un reporte que imprime a archivo PDF, usando una base 
 *                de datos MySQL.
 * @author EktorOrmaetxeaV
 */
public class Main {    
    
    public static void main(String[] args) {
        // Para depuración, descomentar la línea de abajo.
        Depurar();
        
        Cajero cajero = new Cajero();
        int opc;
        
        do {
            SystemUtils.clearScreen();
            System.out.println("Bienvenido al Banco");
            System.out.println("1. Iniciar Sesión");
            System.out.println("2. Crear cuenta");
            System.out.println("0. Salir");
            System.out.print("Seleccione una opción: ");
            opc = InputUtils.getIntInput(""); 

            switch (opc) {
                case 1 ->  { // Iniciar sesion
                    if (cajero.iniciarSesion()) {
                        String cuenta = cajero.getCuentaSesion();
                        SystemUtils.clearScreen();
                        System.out.println("Sesión iniciada correctamente.");
                        System.out.printf("Bienvenido %s.%n", cajero.getUsuarioSesion());
                        SystemUtils.pause();
                        SystemUtils.clearScreen();
                        menuUsuario(cajero, cuenta); // No se necesita pasar el PIN aquí
                    } else {
                        System.out.println("Fallo al iniciar sesión. Volviendo al menú principal.");
                        SystemUtils.pause();
                    }
                }
                case 2 -> { // Crear cuenta                    
                    SystemUtils.clearScreen();
                    cuentaNueva(cajero);
                }
                case 0 -> SystemUtils.clearScreen();
                default -> {
                    System.out.println("Opción no válida");
                    SystemUtils.pause(); 
                }
            }
        } while (opc != 0);        
        
        System.out.println("\nHasta luego . . .\n");
    }
    
    /**
     * Método para mostrar el menú de usuario después de iniciar sesión.
     * @param cajero Instancia del cajero para manejar la lógica de negocio.
     * @param cuenta Número de cuenta del usuario que ha iniciado sesión.
     */
    public static void menuUsuario(Cajero cajero, String cuenta) {
        cajero.registrarEventos(Cajero.Eventos.INICIO_SESION.name(), "Sesion iniciada"); // Usando enum
        int opc;
        do {
            SystemUtils.clearScreen();
            System.out.printf("\nMenú de usuario: %s%n", cajero.getUsuarioSesion());
            System.out.println("1. Consultar Saldo");
            System.out.println("2. Realizar Depósito");
            System.out.println("3. Realizar Retiro");
            System.out.println("4. Cambiar PIN");
            System.out.println("5. Generar Reporte de Movimientos"); // Nueva opción
            System.out.println("0. Salir");
            System.out.print("Seleccione una opción: ");
            opc = InputUtils.getIntInput("");

            switch (opc) {
                case 1 -> {// 1. Consultar Saldo
                    SystemUtils.clearScreen();
                    cajero.consultarSaldo(cuenta,0); // Llamada al método de instancia de Cajero
                }
                case 2 -> {// 2. Realizar Depósito
                    SystemUtils.clearScreen();
                    cajero.realizarDeposito(cuenta); // Llamada al método de instancia de Cajero
                }
                case 3 -> {// 3. Realizar Retiro
                    SystemUtils.clearScreen();
                    cajero.realizarRetiro(cuenta); // Llamada al método de instancia de Cajero
                }
                case 4 ->  {//4. Cambiar PIN
                    String pinAnterior = cajero.getPinSesion();
                    SystemUtils.clearScreen();
                    cajero.cambiarPIN(pinAnterior, cuenta, 1); // Llamada al método de instancia de Cajero
                }
                case 5 -> {// 5. Generar Reporte de Movimientos
                    // Opción para generar reporte
                    SystemUtils.clearScreen();
                    cajero.generarReporte(cajero.getCuentaSesion());
                    SystemUtils.pause();
                }
                case 0 -> {// Salir
                    cajero.registrarEventos(Cajero.Eventos.CIERRE_SESION.name(), "Sesion cerrada"); // Usando enum
                    SystemUtils.clearScreen();
                    System.out.println("Cerrando sesión...\n");                    
                    cajero.cerrarSesion();
                    exitProgram();
                }
                default -> {
                    System.out.println("Opción no válida");
                    SystemUtils.pause();
                }
            }

        } while (opc != 0);
    }

    /**
	 * Método para crear una nueva cuenta de cliente.	 * 
	 * @param cajero Instancia del cajero para manejar la lógica de negocio.
	 */
    public static void cuentaNueva(Cajero cajero) {
        String id;
        System.out.println("Ingrese los datos del cliente: ");
        id = InputUtils.getDigitsInput("Ingrese el DNI/NIE: ", 10);

        cajero.altaCliente(id); 

        if (cajero.isSesionActiva()) {
            SystemUtils.clearScreen();
            System.out.println("Gracias por su preferencia.");
            System.out.printf("Señor(a) %s, su cuenta ha sido dada de alta exitosamente.%n", cajero.getUsuarioSesion());
            System.out.printf("Su PIN de acceso es: %s. ¡Cámbielo de inmediato!%n", cajero.getPinSesion());
            SystemUtils.pause();
            SystemUtils.clearScreen();
            menuUsuario(cajero, cajero.getCuentaSesion());
        } else {
            System.out.println("No se pudo crear la cuenta o iniciar sesión automáticamente. Por favor, intente iniciar sesión manualmente.");
            SystemUtils.pause();
        }
    }

    /**
	 * Método para depurar el sistema de cajero automático.
	 * Este método inicia sesión con una cuenta predefinida para pruebas.
	 * 
	 * Asegúrate de que la cuenta exista en tu base de datos para realizar pruebas.
	 */
    public static void Depurar() {
        Cajero cajero = new Cajero();
        System.out.println("Depuración activada");
        String numCuenta = "11111111111111111111"; 
        System.out.printf("Iniciando sesion a la cuenta %s%n", numCuenta);
        if(cajero.confirmarCuenta(numCuenta)){
            System.out.printf("Pin: %s\n\n",cajero.getPinSesion());
        }        
        if (!cajero.iniciarSesion(numCuenta)) {
            System.out.println("No se pudo iniciar sesión para la cuenta de depuración. Saliendo...");
            SystemUtils.exitProgram();
        } else {
        	menuUsuario(cajero, numCuenta);
            //cajero.generarReporte(numCuenta);
            SystemUtils.pause();
            
            SystemUtils.clearScreen();
            System.out.println("Sesión iniciada correctamente.");
            SystemUtils.pause();
            SystemUtils.clearScreen();
            menuUsuario(cajero,numCuenta);

            System.out.printf("Bienvenido %s%n", cajero.getUsuarioSesion());
            System.out.printf("Cuenta: %s%n", cajero.getCuentaSesion());
            System.out.printf("Saldo: %.2f%n", cajero.getSaldoSesion());
            System.out.printf("PIN: %s%n", cajero.getPinSesion());            
        }
    }
    
}
